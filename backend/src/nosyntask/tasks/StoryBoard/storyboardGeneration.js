/**
 * è‡ªåŠ¨åˆ†é•œå¤„ç†å™¨
 * è°ƒç”¨æ–‡æœ¬æ¨¡å‹å°†å‰§æœ¬å†…å®¹æ‹†åˆ†ä¸ºåˆ†é•œé•œå¤´åˆ—è¡¨
 * 
 * input:  { scriptContent, scriptTitle, textModel }
 * output: { scenes: [...], count }
 */

const handleBaseTextModelCall = require('../base/baseTextModelCall');
const handleRepairJsonResponse = require('./repairJsonResponse');
const { stripThinkTags, extractCodeBlock, extractJSON, stripInvisible } = require('../../../utils/washBody');

async function handleStoryboardGeneration(inputParams, onProgress) {
  const { scriptContent, scriptTitle, textModel: modelName, think } = inputParams;

  if (!scriptContent || scriptContent.trim() === '') {
    throw new Error('å‰§æœ¬å†…å®¹ä¸ºç©ºï¼Œæ— æ³•ç”Ÿæˆåˆ†é•œ');
  }

  if (!modelName) {
    throw new Error('textModel å‚æ•°æ˜¯å¿…éœ€çš„');
  }

  if (onProgress) onProgress(10);

  const fullPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç”µå½±åˆ†é•œå¸ˆï¼Œç²¾é€šè¿ç»­æ€§å‰ªè¾‘ï¼ˆContinuity Editingï¼‰è§„åˆ™ã€‚ä½ çš„ä»»åŠ¡æ˜¯å°†å‰§æœ¬ç»†åŒ–ä¸ºåˆ†é•œï¼Œç¡®ä¿ç›¸é‚»é•œå¤´åœ¨è§†è§‰ä¸Šå¯ä»¥æ— ç¼è¡”æ¥ã€‚

è§„åˆ™ï¼š
1ï¼‰æ¯å¥å¯¹ç™½ç‹¬ç«‹ä¸€ä¸ªé•œå¤´
2ï¼‰æ¯ä¸ªåŠ¨ä½œåˆ†è§£ä¸ºå‡†å¤‡-è¿›è¡Œ-ç»“æœ
3ï¼‰åœºæ™¯åˆ‡æ¢è¦ä»è¿œåˆ°è¿‘å±‚å±‚æ¨è¿›
4ï¼‰ä¸€ä¸ªå‰§æœ¬åœºæ™¯è‡³å°‘æ‹†æˆ5-10ä¸ªé•œå¤´
5ï¼‰ã€å…³é”®ã€‘æ¯ä¸ªé•œå¤´æœ€å¤šåªèƒ½å‡ºç°ä¸€ä¸ªè§’è‰²ï¼Œå¤šè§’è‰²äº’åŠ¨å¿…é¡»æ‹†åˆ†ä¸ºå¤šä¸ªé•œå¤´ï¼ˆä¾‹å¦‚Aå’ŒBå¯¹è¯â†’é•œå¤´1:Aè¯´è¯ç‰¹å†™â†’é•œå¤´2:Bååº”ç‰¹å†™â†’é•œå¤´3:Aå›åº”ï¼‰ï¼Œcharactersæ•°ç»„æœ€å¤šåªèƒ½æœ‰1ä¸ªå…ƒç´ æˆ–ä¸ºç©º

**é‡è¦ï¼šå¿…é¡»è¾“å‡ºä¸¥æ ¼çš„ JSON æ ¼å¼ï¼**
- æ‰€æœ‰å­—ç¬¦ä¸²å€¼å¿…é¡»ç”¨åŒå¼•å·åŒ…è£¹
- ç¡®ä¿ JSON æ ¼å¼å®Œæ•´ï¼Œä»¥ ] ç»“å°¾
- åªè¾“å‡º JSON æ•°ç»„ï¼Œä¸è¦æ·»åŠ å…¶ä»–è¯´æ˜æ–‡å­—

---

è¯·æ ¹æ®ä»¥ä¸‹å‰§æœ¬å†…å®¹ï¼Œå°†å…¶ç»†åŒ–ä¸ºç”µå½±çº§åˆ†é•œé•œå¤´ã€‚

ã€å‰§æœ¬å†…å®¹ã€‘
${scriptContent}

ã€æ ¸å¿ƒè¦æ±‚ - æåº¦ç»†åŒ–ã€‘
1. æ¯ä¸ªåˆ†é•œ = ä¸€ä¸ªé™æ­¢ç”»é¢ï¼Œå¯ç›´æ¥ç”Ÿæˆä¸€å¼ å›¾ç‰‡
2. ã€æœ€é‡è¦ã€‘æ¯ä¸ªé•œå¤´æœ€å¤šåªèƒ½æœ‰1ä¸ªè§’è‰²ï¼ˆcharactersæ•°ç»„é•¿åº¦â‰¤1ï¼‰ï¼š
   - å¤šè§’è‰²äº’åŠ¨å¿…é¡»æ‹†æˆå¤šä¸ªå•äººé•œå¤´äº¤æ›¿å‘ˆç°
   - æ— è§’è‰²çš„ç©ºé•œå¤´ï¼ˆå¦‚é£æ™¯ã€ç‰©å“ç‰¹å†™ï¼‰charactersä¸ºç©ºæ•°ç»„[]
   - ç»å¯¹ç¦æ­¢ä¸€ä¸ªé•œå¤´å‡ºç°2ä¸ªæˆ–ä»¥ä¸Šè§’è‰²
3. å¯¹è¯åœºæ™¯å¿…é¡»æ‹†åˆ†ï¼š
   - æ¯å¥å¯¹ç™½ä¸€ä¸ªé•œå¤´ï¼ˆè¯´è¯äººç‰¹å†™ï¼ŒåªåŒ…å«è¯´è¯äººï¼‰
   - ç©¿æ’å¬è€…ååº”é•œå¤´ï¼ˆåªåŒ…å«å¬è€…ï¼‰
   - é€‚æ—¶åŠ å…¥æ— äººçš„åœºæ™¯å…¨æ™¯ç©ºé•œå¤´
4. åŠ¨ä½œåœºæ™¯å¿…é¡»æ‹†åˆ†ï¼š
   - åŠ¨ä½œå‡†å¤‡é˜¶æ®µ
   - åŠ¨ä½œè¿›è¡Œä¸­
   - åŠ¨ä½œç»“æœ
5. åœºæ™¯åˆ‡æ¢æ—¶ï¼š
   - å…ˆç”¨è¿œæ™¯/å…¨æ™¯å»ºç«‹æ–°åœºæ™¯ï¼ˆæ— è§’è‰²ç©ºé•œå¤´ï¼‰
   - å†é€æ­¥æ¨è¿‘åˆ°è§’è‰²
6. æƒ…ç»ªå˜åŒ–ç‚¹è¦å•ç‹¬ä¸€ä¸ªç‰¹å†™é•œå¤´
7. æ•°é‡è¦æ±‚ï¼šä¸€ä¸ªåœºæ™¯è‡³å°‘æ‹†æˆ 5-10 ä¸ªé•œå¤´

ã€é•œå¤´è¿ç»­æ€§è§„åˆ™ - æå…¶é‡è¦ã€‘
ç›¸é‚»é•œå¤´å¿…é¡»åœ¨è§†è§‰ä¸Šå¯ä»¥æ— ç¼è¡”æ¥ï¼Œéµå®ˆä»¥ä¸‹ä¸“ä¸šå‰ªè¾‘è§„åˆ™ï¼š

1. **å§¿æ€è¿ç»­æ€§ï¼ˆMatch on Actionï¼‰**ï¼š
   - ä¸Šä¸€é•œå¤´ç»“æŸæ—¶è§’è‰²çš„å§¿åŠ¿/ä½ç½®/æœå‘ï¼Œå¿…é¡»ä¸ä¸‹ä¸€é•œå¤´å¼€å§‹æ—¶ä¸€è‡´
   - ä¾‹å¦‚ï¼šä¸Šä¸€é•œå¤´è§’è‰²ç«™ç€ç»“æŸ â†’ ä¸‹ä¸€é•œå¤´è§’è‰²å¿…é¡»ç«™ç€å¼€å§‹ï¼Œä¸èƒ½çªç„¶åç€æˆ–è¶´ç€
   - å¦‚æœéœ€è¦å§¿æ€å˜åŒ–ï¼ˆå¦‚ç«™â†’åï¼‰ï¼Œå¿…é¡»æœ‰ä¸€ä¸ªè¿‡æ¸¡é•œå¤´å±•ç¤ºè¿™ä¸ªåŠ¨ä½œ

2. **æ™¯åˆ«æ¸å˜è§„åˆ™ï¼ˆ30åº¦è§„åˆ™ï¼‰**ï¼š
   - åŒåœºæ™¯å†…ç›¸é‚»é•œå¤´çš„æ™¯åˆ«ä¸èƒ½è·³è·ƒå¤ªå¤§
   - å…è®¸çš„æ¸å˜ï¼šè¿œæ™¯â†”å…¨æ™¯â†”ä¸­æ™¯â†”è¿‘æ™¯â†”ç‰¹å†™ï¼ˆç›¸é‚»çº§åˆ«å¯ä»¥è·³ä¸€çº§ï¼‰
   - ç¦æ­¢ç›´æ¥è·³è·ƒï¼šç‰¹å†™â†’è¿œæ™¯ æˆ– è¿œæ™¯â†’ç‰¹å†™ï¼ˆå¿…é¡»ç»è¿‡ä¸­é—´æ™¯åˆ«è¿‡æ¸¡ï¼‰
   - ä¸åŒåœºæ™¯ä¹‹é—´åˆ‡æ¢ä¸å—æ­¤é™åˆ¶

3. **ç©ºé—´è¿ç»­æ€§ï¼ˆ180åº¦è§„åˆ™ï¼‰**ï¼š
   - åŒä¸€åœºæ™¯å†…ï¼Œé•œå¤´çš„æ‹æ‘„æ–¹å‘åº”ä¿æŒåœ¨åŒä¸€ä¾§
   - è§’è‰²é¢æœå·¦ç¦»å¼€ç”»é¢ â†’ ä¸‹ä¸€é•œå¤´åº”ä»å³ä¾§å…¥ç”»

4. **åœºæ™¯è½¬æ¢è§„åˆ™**ï¼š
   - åˆ‡æ¢åˆ°æ–°åœºæ™¯æ—¶ï¼Œç¬¬ä¸€ä¸ªé•œå¤´å¿…é¡»æ˜¯å»ºç«‹é•œå¤´ï¼ˆè¿œæ™¯/å…¨æ™¯ï¼‰ï¼Œè®©è§‚ä¼—ç†è§£æ–°çš„ç©ºé—´
   - ç„¶åå†é€æ­¥æ¨è¿‘åˆ°è§’è‰²

5. **endState å¿…é¡»ç²¾ç¡®**ï¼š
   - æ¯ä¸ªé•œå¤´å¿…é¡»å¡«å†™ endStateï¼Œå®Œæ•´æè¿°è¯¥é•œå¤´ç»“æŸæ—¶çš„çŠ¶æ€
   - ä¸‹ä¸€ä¸ªé•œå¤´çš„ startFrame/description çš„èµ·å§‹çŠ¶æ€å¿…é¡»ä¸ä¸Šä¸€ä¸ªé•œå¤´çš„ endState ä¸€è‡´

6. **ç¯å¢ƒæ•ˆæœæè¿°è§„èŒƒ - æå…¶é‡è¦**ï¼š
   æ¯ä¸ªé•œå¤´çš„ description ä¸­ï¼Œæ‰€æœ‰ç¯å¢ƒæ•ˆæœå¿…é¡»æŒ‰ä»¥ä¸‹è§„åˆ™ç²¾ç¡®æè¿°ï¼š

   a) **æŒç»­æ€§ vs ä¸€æ¬¡æ€§**ï¼šå¿…é¡»åŒºåˆ†æŒç»­æ€§ç¯å¢ƒï¼ˆå…¨ç¨‹ä¸åœï¼‰å’Œä¸€æ¬¡æ€§äº‹ä»¶ï¼ˆå‘ç”Ÿä¸€æ¬¡å°±ç»“æŸï¼‰
      - æŒç»­æ€§ç¯å¢ƒå¿…é¡»æ˜ç¡®æ ‡æ³¨"æŒç»­"/"ä¸é—´æ–­"/"å…¨ç¨‹"ï¼Œå¦‚ï¼š"æš´é£é›ªæŒç»­è‚†è™ï¼ˆå…¨ç¨‹ä¸åœï¼‰"
      - ä¸€æ¬¡æ€§äº‹ä»¶ç”¨ç¬æ—¶åŠ¨è¯ï¼Œå¦‚ï¼š"ä¸€é“é—ªç”µåˆ’è¿‡å¤©ç©º"
      - ç¦æ­¢æ¨¡ç³Šæè¿°ï¼šä¸èƒ½åªå†™"æš´é£é›ª"è€Œä¸è¯´æ˜æ˜¯æŒç»­è¿˜æ˜¯çŸ­æš‚

   b) **å¼ºåº¦é‡åŒ–**ï¼šæ¯ä¸ªç¯å¢ƒæ•ˆæœå¿…é¡»æ ‡æ³¨å¼ºåº¦ç­‰çº§
      - ä½¿ç”¨æ˜ç¡®çš„å¼ºåº¦è¯ï¼šå¾®å¼±/è½»å¾®/ä¸­ç­‰/å¼ºçƒˆ/çŒ›çƒˆ
      - é”™è¯¯ç¤ºä¾‹ï¼š "é—ªç”µåœ¨ä¹Œäº‘ä¸­è‹¥éšè‹¥ç°" â†’ è§†é¢‘æ¨¡å‹ä¼šç”ŸæˆçŒ›çƒˆé—ªç”µ
      - æ­£ç¡®ç¤ºä¾‹ï¼š "æè¿œå¤„ä¹Œäº‘ä¸­å¶å°”æœ‰ä¸€ä¸å¾®å¼±çš„ç”µå…‰é—ªçƒï¼ˆéå¸¸å¾®å¼±ï¼Œä»…æ˜¯äº‘å±‚å†…éƒ¨çš„å¾®å…‰ï¼Œæ²¡æœ‰é›·å£°ï¼‰"
      - ç‰¹åˆ«æ³¨æ„ï¼š"è‹¥éšè‹¥ç°""éšçº¦""æ·¡æ·¡çš„"è¿™ç±»å«è“„ä¿®è¾å¿…é¡»è½¬æ¢ä¸ºæ˜ç¡®çš„å¼ºåº¦æè¿°

   c) **å®¤å†…å¤–ç¯å¢ƒéš”ç¦»**ï¼š
      - å®¤å¤–ç¯å¢ƒæ•ˆæœä¸èƒ½ç›´æ¥"ç©¿è¶Š"åˆ°å®¤å†…
      - å®¤å†…é•œå¤´æè¿°å¤–éƒ¨å¤©æ°”æ—¶ï¼Œå¿…é¡»æ˜ç¡®è¯´æ˜æ˜¯"é€è¿‡çª—æˆ·/é—¨ç¼æ„Ÿå—åˆ°çš„"ï¼Œå¹¶ä¸”å¼ºåº¦å¤§å¹…è¡°å‡
      - é”™è¯¯ç¤ºä¾‹ï¼š "åº™å†…ï¼Œé£é›ªçŒå…¥" â†’ è§†é¢‘æ¨¡å‹ä¼šåœ¨å®¤å†…ç”Ÿæˆæš´é£é›ª
      - æ­£ç¡®ç¤ºä¾‹ï¼š "åº™å†…ï¼Œå°‘é‡ç»†å°é›ªç²’ä»ç ´æŸçš„çª—æ£‚ç¼éš™ä¸­è¢«é£å¸¦å…¥ï¼Œåœ¨ç«å…‰ä¸­å¯è§é›¶æ˜Ÿé£˜è½çš„é›ªèŠ±"
      - å®¤å†…ä¸å¯èƒ½å‡ºç°ï¼šå®¤å¤–çº§åˆ«çš„æš´é£é›ªã€ç›´æ¥çš„é—ªç”µå…‰ç…§ã€å¤§é¢ç§¯é™é›¨

   d) **ç‰©ç†äº¤äº’åˆç†æ€§**ï¼š
      - ç¯å¢ƒæ•ˆæœä¸ç‰©ä½“/ç©ºé—´çš„äº¤äº’å¿…é¡»ç¬¦åˆç‰©ç†è§„å¾‹
      - é€šè¿‡ç¼éš™è¿›å…¥çš„é£é›ªï¼šåªèƒ½æ˜¯å°‘é‡ã€ç»†å°ã€è¢«é£æŒ¤å…¥çš„
      - é€è¿‡çª—æˆ·çš„å…‰ï¼šä¼šè¢«çª—æ¡†é®æŒ¡å’Œæ•£å°„ï¼Œä¸æ˜¯ç›´å°„
      - å®¤å†…ç«ç„°å—é£å½±å“ï¼šå¾®å¾®æ‘‡æ›³ï¼Œä¸ä¼šè¢«å¹ç­ï¼ˆé™¤éå‰§æƒ…éœ€è¦ï¼‰

ã€è¾“å‡º JSON æ ¼å¼ã€‘
æ¯ä¸ªåˆ†é•œåŒ…å«ï¼š
- order: åˆ†é•œåºå·ï¼ˆä»1å¼€å§‹ï¼‰
- shotType: é•œå¤´ç±»å‹ï¼ˆ"ç‰¹å†™"/"è¿‘æ™¯"/"ä¸­æ™¯"/"å…¨æ™¯"/"è¿œæ™¯"/"ä¿¯æ‹"/"ä»°æ‹"/"è¿‡è‚©"ï¼‰
- description: ç”»é¢æè¿°ï¼ˆè¯¦ç»†æè¿°ç”»é¢å†…å®¹ï¼Œè¦è¶³å¤Ÿè¯¦ç»†ï¼Œå¯ç›´æ¥ç”¨äºAIç”Ÿå›¾ï¼‰
- hasAction: æ˜¯å¦æœ‰åŠ¨ä½œï¼ˆtrue/falseï¼‰
- startFrame: é¦–å¸§æè¿°ï¼ˆä»…å½“hasAction=trueæ—¶ï¼Œæè¿°åŠ¨ä½œå¼€å§‹ç¬é—´çš„ç”»é¢ï¼‰
- endFrame: å°¾å¸§æè¿°ï¼ˆä»…å½“hasAction=trueæ—¶ï¼Œæè¿°åŠ¨ä½œå®Œæˆç¬é—´çš„ç”»é¢ï¼‰
- endState: ã€å¿…å¡«ã€‘é•œå¤´ç»“æŸæ—¶çš„å®Œæ•´çŠ¶æ€å¿«ç…§ã€‚ä¸‹ä¸€ä¸ªé•œå¤´çš„èµ·å§‹çŠ¶æ€å¿…é¡»ä¸æ­¤ä¸€è‡´ã€‚
  Â· æœ‰è§’è‰²çš„é•œå¤´ã€å¿…é¡»ã€‘åŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼ˆç¼ºä¸€ä¸å¯ï¼‰ï¼š
    â‘  ä½ç½®ï¼šè§’è‰²åœ¨åœºæ™¯ä¸­çš„å…·ä½“æ–¹ä½ï¼ˆå¦‚ã€Œåº™å†…ä¸­å¤®åå·¦ã€ã€Œé—¨å£å³ä¾§ã€ã€Œçª—è¾¹ã€ï¼Œéœ€æè¿°ä¸åœºæ™¯åœ°æ ‡çš„ç›¸å¯¹å…³ç³»ï¼‰
    â‘¡ æœå‘ï¼šè§’è‰²é¢æœ/èƒŒå¯¹çš„æ–¹å‘ï¼ˆå¦‚ã€Œé¢æœåº™é—¨æ–¹å‘ã€ã€ŒèƒŒå¯¹çª—æˆ·ï¼Œä¾§èº«æœå‘ç¯ç«ã€ï¼‰
    â‘¢ å§¿åŠ¿ï¼šèº«ä½“å§¿æ€ï¼ˆç«™/å/è¹²/èºº/è·‘ç­‰ï¼‰+ è‚¢ä½“ä½ç½® + æ‰‹ä¸­ç‰©å“
    â‘£ è¡¨æƒ…ï¼šé¢éƒ¨è¡¨æƒ…çŠ¶æ€
    â‘¤ æ—¶ç©ºæ–¹ä½ï¼šå½“å‰æ—¶é—´æ®µï¼ˆå¦‚ã€Œæ·±å¤œã€ã€Œé»„æ˜ã€ï¼‰åŠè§’è‰²æ‰€å¤„ç©ºé—´ä¸å‘¨å›´ç¯å¢ƒçš„å…³ç³»ï¼ˆå¦‚ã€Œç¯ç«æ˜ ç…§ä¸‹ã€ã€Œæœˆå…‰ä»çª—å¤–é€å…¥ã€ï¼‰
  Â· æ— è§’è‰²é•œå¤´åªæè¿°åœºæ™¯ç¯å¢ƒçŠ¶æ€ï¼ˆé—¨å¼€/å…³ã€ç¯äº®/ç­ã€å¤©æ°”å˜åŒ–ç­‰ï¼‰+ æ—¶ç©ºæ–¹ä½
- dialogue: å¯¹ç™½å†…å®¹ï¼ˆå¦‚æœæœ‰ï¼‰
- duration: å»ºè®®æ—¶é•¿ï¼ˆç§’ï¼‰
- characters: å‡ºç°çš„è§’è‰²æ•°ç»„ï¼ˆ**æœ€å¤š1ä¸ªå…ƒç´ **ï¼Œå¦‚["ä¸»è§’"]æˆ–[]ï¼Œç¦æ­¢å‡ºç°2ä¸ªä»¥ä¸Šè§’è‰²ï¼‰
- location: åœºæ™¯åœ°ç‚¹
- emotion: æƒ…ç»ªæ°›å›´
- cameraMovement: é•œå¤´è¿åŠ¨æè¿°ï¼Œä»ä»¥ä¸‹é€‰æ‹©æˆ–ç»„åˆï¼š
  Â· "static"ï¼ˆé™æ­¢ï¼‰- å›ºå®šæœºä½ï¼Œæ— è¿åŠ¨
  Â· "push_in"ï¼ˆæ¨è¿‘ï¼‰- é•œå¤´å‘ä¸»ä½“æ¨è¿›ï¼Œè¥é€ ç´§è¿«æ„Ÿæˆ–èšç„¦
  Â· "pull_out"ï¼ˆæ‹‰è¿œï¼‰- é•œå¤´è¿œç¦»ä¸»ä½“ï¼Œæ­ç¤ºç¯å¢ƒæˆ–åˆ¶é€ ç–ç¦»æ„Ÿ
  Â· "pan_left" / "pan_right"ï¼ˆå·¦æ‘‡/å³æ‘‡ï¼‰- é•œå¤´æ°´å¹³æ—‹è½¬ï¼Œè·Ÿéšæˆ–æ‰«è§†
  Â· "tilt_up" / "tilt_down"ï¼ˆä¸Šæ‘‡/ä¸‹æ‘‡ï¼‰- é•œå¤´å‚ç›´æ—‹è½¬ï¼Œä»°è§†æˆ–ä¿¯è§†
  Â· "track_left" / "track_right"ï¼ˆå·¦ç§»/å³ç§»ï¼‰- é•œå¤´å¹³è¡Œç§»åŠ¨ï¼Œè·Ÿéšè§’è‰²è¡Œèµ°
  Â· "zoom_in" / "zoom_out"ï¼ˆå˜ç„¦æ¨/å˜ç„¦æ‹‰ï¼‰- ç„¦è·å˜åŒ–ï¼Œä¸æ”¹å˜æœºä½
  Â· "follow"ï¼ˆè·Ÿéšï¼‰- é•œå¤´è·Ÿéšè§’è‰²è¿åŠ¨
  Â· "crane_up" / "crane_down"ï¼ˆå‡/é™ï¼‰- é•œå¤´å‚ç›´å‡é™
  Â· "orbit"ï¼ˆç¯ç»•ï¼‰- å›´ç»•ä¸»ä½“æ—‹è½¬
  Â· "shake"ï¼ˆæ‰‹æŒæ™ƒåŠ¨ï¼‰- æ¨¡æ‹Ÿæ‰‹æŒæ‹æ‘„çš„ä¸ç¨³å®šæ„Ÿï¼Œé€‚åˆç´§å¼ /åŠ¨ä½œåœºæ™¯
  å¯ä»¥ç»„åˆä½¿ç”¨ï¼Œå¦‚ "push_in + tilt_down"ï¼ˆæ¨è¿‘åŒæ—¶ä¸‹æ‘‡ï¼‰

åªè¾“å‡º JSON æ•°ç»„ï¼Œä¸è¦å…¶ä»–å†…å®¹ã€‚ç¤ºä¾‹ï¼ˆæ³¨æ„æ¯ä¸ªé•œå¤´æœ€å¤š1ä¸ªè§’è‰²ï¼ŒendStateå¿…é¡»ç²¾ç¡®ï¼Œç›¸é‚»é•œå¤´çŠ¶æ€å¿…é¡»è¡”æ¥ï¼‰ï¼š
[
  {"order": 1, "shotType": "è¿œæ™¯", "description": "æš´é£é›ªæŒç»­è‚†è™çš„æ·±å¤œï¼ˆé£é›ªå…¨ç¨‹ä¸åœï¼Œå¼ºåº¦ï¼šçŒ›çƒˆï¼‰ï¼Œç ´è´¥çš„å±±ç¥åº™å­¤ç«‹åœ¨è’å±±ä¸­ï¼Œåº™é¡¶ç§¯é›ªåšé‡ï¼Œæ¯æ ‘åœ¨å¼ºé£ä¸­å‰§çƒˆæ‘‡æ‘†ï¼Œæè¿œå¤„ä¹Œäº‘æ·±å¤„å¶å°”é—ªè¿‡ä¸€ä¸å¾®å¼±ç”µå…‰ï¼ˆå¼ºåº¦ï¼šæå¾®å¼±ï¼Œä»…äº‘å±‚å†…éƒ¨å¾®å…‰ï¼Œæ— é›·å£°ï¼‰", "hasAction": false, "endState": "ã€æ—¶ç©ºã€‘æ·±å¤œï¼Œå±±ç¥åº™å¤–æ™¯ï¼Œæš´é£é›ªæŒç»­è‚†è™ï¼›åº™é—¨åŠæ©ï¼Œåº™å‰ç©ºåœ°æ— äººï¼Œè¿œå¤„äº‘å±‚å¶ç°å¾®å¼±ç”µå…‰", "dialogue": "", "duration": 2, "characters": [], "location": "å±±ç¥åº™å¤–", "emotion": "è§ç‘Ÿ", "cameraMovement": "static"},
  {"order": 2, "shotType": "å…¨æ™¯", "description": "å±±ç¥åº™å†…éƒ¨æ˜æš—ï¼Œä¸­å¤®ç¯ç«å¾®å¼±æ‘‡æ›³ï¼ˆç«å…‰å¼ºåº¦ï¼šå¾®å¼±ï¼ŒæŒç»­ç‡ƒçƒ§ï¼‰ï¼Œæ—å†²è£¹ç€ç ´æ—§æ£‰è¢„ä¾§å§åœ¨ä¾›æ¡Œæ—ç¨»è‰å †ä¸Šï¼ŒèŠ±æªé å¢™ã€‚å°‘é‡ç»†å°é›ªç²’ä»ç ´æŸçª—æ£‚ç¼éš™è¢«é£å¸¦å…¥ï¼ˆå®¤å†…é£é›ªå¼ºåº¦ï¼šæè½»å¾®ï¼Œä»…é›¶æ˜Ÿé›ªç²’é£˜è½ï¼‰ï¼Œåº™å¤–æš´é£é›ªçš„å‘¼å•¸å£°éšçº¦å¯é—»", "hasAction": false, "endState": "ã€ä½ç½®ã€‘åº™å†…ä¾›æ¡Œæ—ç¨»è‰å †ä¸Šï¼ˆé è¿‘ä¸œå¢™ï¼‰ã€æœå‘ã€‘é¢æœä¾›æ¡Œæ–¹å‘ï¼ˆèº«ä½“æœè¥¿ï¼‰ã€å§¿åŠ¿ã€‘ä¾§å§ï¼ŒåŒè…¿å¾®æ›²ï¼ŒèŠ±æªé å¢™äºå³æ‰‹å¯åŠå¤„ã€è¡¨æƒ…ã€‘åŒçœ¼å¾®é—­ï¼Œé¢å®¹ç–²æƒ«ã€æ—¶ç©ºã€‘æ·±å¤œï¼Œç¯ç«å¾®å¼±æ˜ ç…§ï¼Œçª—ç¼å¶æœ‰é›ªç²’é£˜å…¥", "dialogue": "", "duration": 2, "characters": ["æ—å†²"], "location": "å±±ç¥åº™å†…", "emotion": "å‡„å‡‰", "cameraMovement": "push_in"},
  {"order": 3, "shotType": "ç‰¹å†™", "description": "æ—å†²è€³æœµç‰¹å†™ï¼Œç¯ç«å¾®å…‰æ˜ ç…§ï¼ˆæŒç»­ï¼‰ï¼Œä»–çŒ›ç„¶ççœ¼ä¾§è€³å€¾å¬ï¼Œåº™å¤–éšçº¦ä¼ æ¥é©¬è¹„å£°ï¼ˆå¼ºåº¦ï¼šå¾®å¼±ï¼Œè¢«é£é›ªå£°é®ç›–å¤§åŠï¼‰", "hasAction": true, "startFrame": "æ—å†²ä¾§å§å§¿æ€ï¼Œè€³æœµç‰¹å†™ï¼ŒåŒçœ¼å¾®é—­ï¼Œç¯ç«å¾®å…‰æ˜ ç…§", "endFrame": "æ—å†²åŒçœ¼åœ†çï¼Œçœ‰å¤´ç´§é”ï¼Œä¾§è€³å‡å¬", "endState": "ã€ä½ç½®ã€‘åº™å†…ä¾›æ¡Œæ—ç¨»è‰å †ä¸Šï¼ˆé è¿‘ä¸œå¢™ï¼‰ã€æœå‘ã€‘é¢æœä¾›æ¡Œæ–¹å‘ï¼Œå¤´å¾®è½¬å‘åº™é—¨æ–¹å‘ä¾§è€³ã€å§¿åŠ¿ã€‘ä¾§å§ï¼Œè‚Œè‚‰ç´§ç»·ï¼ŒåŒæ‰‹æœªåŠ¨ã€è¡¨æƒ…ã€‘åŒçœ¼åœ†çï¼Œçœ‰å¤´ç´§é”ï¼Œè­¦è§‰ã€æ—¶ç©ºã€‘æ·±å¤œï¼Œç¯ç«å¾®å…‰æ˜ ç…§è€³å»“", "dialogue": "", "duration": 2, "characters": ["æ—å†²"], "location": "å±±ç¥åº™å†…", "emotion": "è­¦è§‰", "cameraMovement": "static"},
  {"order": 4, "shotType": "è¿‘æ™¯", "description": "æ—å†²ä»ç¨»è‰å †ä¸ŠçŒ›ç„¶ç¿»èº«åèµ·ï¼Œä¸€æ‰‹æ’‘åœ°ä¸€æ‰‹å»å¤Ÿå¢™è¾¹çš„èŠ±æªï¼Œç¯ç«å› åŠ¨ä½œå¸¦èµ·çš„æ°”æµå¾®å¾®æ™ƒåŠ¨ï¼ˆè½»å¾®æ™ƒåŠ¨ï¼Œä¸ç†„ç­ï¼‰", "hasAction": true, "startFrame": "æ—å†²ä¾§å§åœ¨ç¨»è‰å †ä¸Šï¼ŒåŒçœ¼åœ†çè­¦è§‰", "endFrame": "æ—å†²åèµ·èº«ï¼Œå³æ‰‹å·²æ¡ä½èŠ±æªæªæ†", "endState": "ã€ä½ç½®ã€‘åº™å†…ç¨»è‰å †ä¸Šï¼ˆä¾›æ¡Œæ—ï¼Œé è¿‘ä¸œå¢™ï¼‰ã€æœå‘ã€‘ä¸Šèº«è½¬å‘åº™é—¨æ–¹å‘ï¼ˆæœå—ï¼‰ã€å§¿åŠ¿ã€‘åå§¿ï¼Œå³æ‰‹æ¡èŠ±æªæªæ†ï¼Œå·¦æ‰‹æ’‘åœ°ï¼Œä¸Šèº«å‰å€¾ã€è¡¨æƒ…ã€‘è­¦æƒ•ï¼ŒåŒçœ¼ç´§ç›¯åº™é—¨æ–¹å‘ã€æ—¶ç©ºã€‘æ·±å¤œï¼Œç¯ç«å› æ°”æµå¾®å¾®æ™ƒåŠ¨", "dialogue": "", "duration": 2, "characters": ["æ—å†²"], "location": "å±±ç¥åº™å†…", "emotion": "ç´§å¼ ", "cameraMovement": "track_right + tilt_up"},
  {"order": 5, "shotType": "ä¸­æ™¯", "description": "æ—å†²æ¡æªç«™èµ·ï¼ŒåŒè„šåˆ†å¼€ç«™ç¨³ï¼ŒèŠ±æªæ–œæŒ‡åœ°é¢ï¼Œèº«ä½“å¾®å‰å€¾åšæˆ’å¤‡å§¿æ€ï¼Œç¯ç«åœ¨èº«åæŒç»­ç‡ƒçƒ§ï¼ˆæŒç»­ï¼‰ï¼Œå°†ä»–çš„å½±å­æŠ•å°„åœ¨æ®‹ç ´å¢™é¢ä¸Š", "hasAction": true, "startFrame": "æ—å†²ååœ¨ç¨»è‰å †ä¸Šï¼Œå³æ‰‹æ¡æªï¼Œç¯ç«å¾®å…‰", "endFrame": "æ—å†²ç«™ç«‹ï¼ŒåŒè„šåˆ†å¼€ï¼ŒèŠ±æªæ–œæŒ‡åœ°é¢ï¼Œæˆ’å¤‡å§¿æ€ï¼Œèº«åç¯ç«æ˜ å‡ºé•¿å½±", "endState": "ã€ä½ç½®ã€‘åº™å†…ä¸­å¤®åå—ï¼ˆè·åº™é—¨çº¦ä¸‰æ­¥ï¼‰ã€æœå‘ã€‘é¢æœåº™é—¨æ–¹å‘ï¼ˆæ­£å—ï¼‰ï¼Œèº«ä½“å¾®å‰å€¾ã€å§¿åŠ¿ã€‘ç«™ç«‹ï¼ŒåŒè„šä¸è‚©åŒå®½ï¼Œå³æ‰‹æ¡èŠ±æªæ–œæŒ‡åœ°é¢ï¼Œå·¦æ‰‹å¾®æŠ¬æŠ¤èº«ã€è¡¨æƒ…ã€‘ç›®å…‰é”åˆ©ï¼Œæ³¨è§†åº™é—¨æ–¹å‘ã€æ—¶ç©ºã€‘æ·±å¤œï¼Œèº«åç¯ç«æŒç»­ç‡ƒçƒ§ï¼Œå°†é•¿å½±æŠ•å°„åœ¨åŒ—å¢™ä¸Š", "dialogue": "", "duration": 2, "characters": ["æ—å†²"], "location": "å±±ç¥åº™å†…", "emotion": "è‚ƒæ€", "cameraMovement": "crane_up + pull_out"}
]`;

  const result = await handleBaseTextModelCall({
    prompt: fullPrompt,
    textModel: modelName,
    maxTokens: 8192,
    temperature: 0.3,
    think
  }, onProgress);

  if (onProgress) onProgress(80);

  // è§£æ AI è¿”å›çš„ JSON
  let scenes = [];
  try {
    console.log('[StoryboardGen] å“åº”æ€»é•¿åº¦:', result.content.length, 'å­—ç¬¦');

    // 1. ç»Ÿä¸€æ¸…æ´—ï¼šå» think æ ‡ç­¾ + æå–ä»£ç å— + å»ä¸å¯è§å­—ç¬¦
    let jsonStr = stripThinkTags(result.content);
    jsonStr = extractCodeBlock(jsonStr);
    jsonStr = stripInvisible(jsonStr).trim();

    // 2. å°è¯•ç›´æ¥è§£æ
    try {
      scenes = JSON.parse(jsonStr);
      console.log('[StoryboardGen] âœ… ç›´æ¥è§£ææˆåŠŸï¼Œå…±', scenes.length, 'ä¸ªåˆ†é•œ');
    } catch (directParseError) {
      // 2.5 å°è¯•æå– JSON ç‰‡æ®µ
      const extracted = extractJSON(jsonStr);
      if (extracted) {
        try {
          scenes = JSON.parse(extracted);
          console.log('[StoryboardGen] âœ… æå– JSON ç‰‡æ®µè§£ææˆåŠŸï¼Œå…±', scenes.length, 'ä¸ªåˆ†é•œ');
        } catch (_) { /* ç»§ç»­å¾€ä¸‹ fallback */ }
      }

      if (!Array.isArray(scenes) || scenes.length === 0) {
        // 3. jsonrepair åº“ä¿®å¤
        console.log('[StoryboardGen] ç›´æ¥è§£æå¤±è´¥ï¼Œä½¿ç”¨ jsonrepair ä¿®å¤...');
        try {
          const { jsonrepair } = await import('jsonrepair');
          const repaired = jsonrepair(jsonStr);
          scenes = JSON.parse(repaired);
          console.log('[StoryboardGen] âœ… jsonrepair ä¿®å¤æˆåŠŸï¼Œå…±', scenes.length, 'ä¸ªåˆ†é•œ');
        } catch (repairLibError) {
          console.error('[StoryboardGen] âŒ jsonrepair ä¿®å¤å¤±è´¥:', repairLibError.message);

          // 4. æœ€åæ‰‹æ®µï¼šè°ƒç”¨ AI ä¿®å¤
          console.log('[StoryboardGen] ğŸ”§ è°ƒç”¨ AI ä¿®å¤ä»»åŠ¡...');
          try {
            const repairResult = await handleRepairJsonResponse({
              incompleteJson: jsonStr,
              originalPrompt: fullPrompt,
              textModel: modelName
            }, (progress) => {
              if (onProgress) onProgress(80 + progress * 0.15);
            });

            if (repairResult.success && repairResult.repairedJson) {
              scenes = repairResult.repairedJson;
              console.log('[StoryboardGen] âœ… AI ä¿®å¤æˆåŠŸï¼Œå…±', scenes.length, 'ä¸ªåˆ†é•œ');
            } else {
              throw new Error('AI ä¿®å¤ä¹Ÿå¤±è´¥: ' + (repairResult.error || directParseError.message));
            }
          } catch (aiRepairError) {
            console.error('[StoryboardGen] âŒ AI ä¿®å¤å¤±è´¥:', aiRepairError);
            throw new Error('åˆ†é•œ JSON è§£æå¤±è´¥ï¼Œjsonrepair å’Œ AI ä¿®å¤å‡å¤±è´¥: ' + directParseError.message);
          }
        }
      }
    }
  } catch (parseError) {
    console.error('[StoryboardGen] è§£æåˆ†é•œ JSON å¤±è´¥:', parseError);
    console.error('[StoryboardGen] å®Œæ•´å“åº”å†…å®¹:', result.content);
    throw new Error('åˆ†é•œè§£æå¤±è´¥: ' + parseError.message);
  }

  if (!Array.isArray(scenes) || scenes.length === 0) {
    throw new Error('AI æœªè¿”å›æœ‰æ•ˆçš„åˆ†é•œæ•°æ®');
  }

  if (onProgress) onProgress(100);

  return {
    scenes,
    count: scenes.length,
    tokens: result.tokens || 0,
    provider: result._model?.provider || 'unknown'
  };
}

module.exports = handleStoryboardGeneration;
